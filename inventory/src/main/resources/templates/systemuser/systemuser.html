<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SystemUser Management</title>
    <!-- CSS and JavaScript dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for styling */
        body {
            font-family: 'Roboto', sans-serif;
        }
        .header-dark {
            background-color: #343a40;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .role-box {
            display: inline-block;
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background-color: #f8f9fa;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            position: relative;
        }
        .role-box .remove-role {
            position: absolute;
            top: 2px;
            right: 5px;
            cursor: pointer;
            color: red;
        }
        .validation-error {
            color: red;
            font-size: 0.9em;
        }
        .is-invalid {
            border-color: red !important;
            box-shadow: 0 0 5px red !important;
        }
        .is-valid {
            border-color: green !important;
            box-shadow: 0 0 5px green !important;
        }
    </style>
    <style>
        /* Modal CSS */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .custom-modal-dialog {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        }

        .custom-modal-header,
        .custom-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-modal-header {
            border-bottom: 1px solid #ddd;
        }

        .custom-modal-footer {
            border-top: 1px solid #ddd;
        }

        .custom-modal-title {
            margin: 0;
        }

        .hidden {
            visibility: hidden;
            opacity: 0;
        }

        .visible {
            visibility: visible;
            opacity: 1;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('#systemuserform');

            // Helper function to validate individual fields
            const validateField = (field, condition, errorMessage) => {
                const errorElement = field.nextElementSibling;
                if (!condition) {
                    field.classList.add('is-invalid');
                    field.classList.remove('is-valid');
                    errorElement.textContent = errorMessage;
                } else {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                    errorElement.textContent = '';
                }
            };

            // Event listeners for real-time validation
            const nameField = form.querySelector('input[name="name"]');
            nameField.addEventListener('input', () => {
                validateField(nameField, /^[A-Za-z\s]+$/.test(nameField.value), 'Name should contain only letters and spaces.');
            });

            const emailField = form.querySelector('input[name="email"]');
            emailField.addEventListener('input', () => {
                validateField(emailField, /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value), 'Invalid email format.');
            });

            const phoneField = form.querySelector('input[name="phone"]');
            phoneField.addEventListener('input', () => {
                phoneField.value = phoneField.value.replace(/\D/g, '').slice(0, 10);
                validateField(phoneField, phoneField.value.length === 10, 'Phone number must be exactly 10 digits.');
            });

<!--            const passwordField = form.querySelector('input[name="password"]');-->
<!--            const password2Field = form.querySelector('input[name="password2"]');-->
<!--            passwordField.addEventListener('input', () => {-->
<!--                validateField(passwordField, passwordField.value.length >= 6, 'Password must be at least 6 characters long.');-->
<!--            });-->
<!--            password2Field.addEventListener('input', () => {-->
<!--                validateField(password2Field, passwordField.value === password2Field.value, 'Passwords do not match.');-->
<!--            });-->

            // Form submit validation
            form.addEventListener('submit', function (e) {
                let isValid = true;
                const errors = document.querySelectorAll('.validation-error');
                errors.forEach(error => error.textContent = '');

                // Final validation check before submission
                validateField(nameField, /^[A-Za-z\s]+$/.test(nameField.value), 'Name should contain only letters and spaces.');
                validateField(emailField, /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value), 'Invalid email format.');
                validateField(phoneField, phoneField.value.length === 10, 'Phone number must be exactly 10 digits.');
                validateField(passwordField, passwordField.value.length >= 6, 'Password must be at least 6 characters long.');
                validateField(password2Field, passwordField.value === password2Field.value, 'Passwords do not match.');

                // Prevent form submission if invalid
                if (!form.querySelectorAll('.is-valid').length === form.querySelectorAll('input').length) {
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                }
            });
        });
    </script>
</head>
<body>

<!--<div th:insert="fragments/adminnavbar.html :: adminnavbarfragment"> </div>-->
<div th:insert="fragments/adminnavbar.html :: adminnavbarfragment"> </div>

<div class="container">
    <!-- Header -->
    <div class="header-dark">
        <h1>System User Management</h1>
        <p>Manage System Users</p>
    </div>

    <div id="successDiv" class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">
        Success
    </div>

    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">
        Error
    </div>

    <!-- Form for SystemUserDAO -->
    <form id="systemuserform" th:if="${systemuser.id > 0}" th:action="@{/systemuser/edit}" method="post" th:object="${systemuser}">

        <input type="hidden" th:field="*{id}">

        <div class="row">
            <!-- Name -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" th:field="*{name}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Email -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" th:field="*{email}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Phone -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Phone</label>
                <input type="text" class="form-control" th:field="*{phone}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Password -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Change Password</label>
                Coming soon
<!--                <input type="password" class="form-control" th:field="*{password}" required>-->
<!--                <span class="validation-error"></span>-->
            </div>

            <!-- Project -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Tenant</label>
                <input type="text" class="form-control" th:field="*{tenant}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Roles -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Roles</label>
                <!-- Add Role Button -->
                <button type="button" class="btn btn-success btn-sm ms-3" onclick="showModal('rolesModal')">
                    Add Role
                </button>
                <div id="selectedRoles">
                    <!-- Display existing roles -->
                    <span th:each="role : ${systemuser.roles}" class="role-box d-flex align-items-center justify-content-between" th:id="'role-' + ${role}">
                        <span th:text="${role}"></span>
                        <i class="bi bi-x-circle-fill remove-role ms-3"
                           th:attr="data-role=${role}"
                           title="Remove role"
                           style="font-size: 1.4rem; color: red; cursor: pointer;"></i>
                                            <!-- Still include the current role list for display -->
                        <input type="hidden" name="roles" th:id="'input-role-' + ${role}" th:value="${role}" />
                    </span>

                </div>
            </div>

            <!-- Modal -->
            <div id="rolesModal" class="custom-modal hidden">
                <div class="custom-modal-dialog">
                    <div class="custom-modal-content">
                        <div class="custom-modal-header">
                            <h5 class="custom-modal-title">Add Role</h5>
                            <button type="button" class="btn-close" onclick="hideModal('rolesModal')">×</button>
                        </div>
                        <div class="custom-modal-body">
                            <select id="availableRoles" class="form-select" multiple>
                                <option th:each="roleOption : ${allRoles}" th:value="${roleOption}" th:text="${roleOption}"></option>
                            </select>
                        </div>
                        <div class="custom-modal-footer">
                            <button type="button" class="btn btn-primary" onclick="addSelectedRoleAndSubmit()">Add</button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal('rolesModal')">Close</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- User Active -->
            <!-- User Active -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Is Active</label>
                <input
                        type="checkbox"
                        class="form-check-input"
                        id="isuseractive"
                        th:field="*{isuseractive}"
                        value="1"
                th:checked="${isuseractive == 1}"
                onclick="updateIsUserActive()">
                <input type="hidden" id="isuseractiveHidden" name="isuseractive" th:field="*{isuseractive}">
                <span class="validation-error"></span>
            </div>
            <script>
                function updateIsUserActive() {
                    const checkbox = document.getElementById('isuseractive');
                    const hiddenField = document.getElementById('isuseractiveHidden');
                    hiddenField.value = checkbox.checked ? 1 : 0; // Set hidden field value to 1 or 0
                }

                document.addEventListener('DOMContentLoaded', function () {
                    const checkbox = document.getElementById('isuseractive');
                    const hiddenField = document.getElementById('isuseractiveHidden');
                    hiddenField.value = checkbox.checked ? 1 : 0; // Ensure hidden field is updated on page load
                });
            </script>

            <!-- Created Timestamp -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Created Timestamp</label>
                <input type="text" class="form-control" th:field="*{createtimestamp}" readonly>
            </div>

            <!-- Updated Timestamp -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Updated Timestamp</label>
                <input type="text" class="form-control" th:field="*{updatedtimestamp}" readonly>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">
            <span>Update User</span>
        </button>
    </form>

    <!-- Users List -->
    <div class="header-dark mt-4">
        <h2>System Users</h2>
    </div>
    <table class="table table-hover">
        <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${systemuserPage.content}">
            <td th:text="${user.name}"></td>
            <td th:text="${user.email}"></td>
            <td th:text="${user.phone}"></td>
            <td>
                <a th:href="@{/systemuser(systemuserid=${user.id})}" class="btn btn-sm btn-warning">Edit</a>
                <form th:action="@{/systemuser/delete}" method="post" style="display:inline;">
                    <input type="hidden" name="id" th:value="${user.id}">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
                </form>
            </td>
        </tr>
        <script>
            function updateAvailableRoles() {
                const availableRoles = document.getElementById('availableRoles');
                const selectedRoles = document.getElementById('selectedRoles');

                // Create a set of currently selected role values
                const selectedRoleIds = new Set(
                    Array.from(selectedRoles.querySelectorAll('.role-box')).map(roleBox => roleBox.id.replace('role-', ''))
                );

                // Iterate through all the options in the roles dropdown
                Array.from(availableRoles.options).forEach(option => {
                    // Disable options already added to selectedRoles
                    if (selectedRoleIds.has(option.value)) {
                        option.disabled = true;
                        option.style.color = '#ccc'; // Visual indicator for disabled option
                    } else {
                        option.disabled = false;
                        option.style.color = ''; // Reset style for enabled option
                    }
                });
            }

    function addSelectedRole() {
        const availableRoles = document.getElementById('availableRoles');
        const selectedRolesContainer = document.getElementById('selectedRoles');

        // Iterate over selected options in the roles dropdown
        Array.from(availableRoles.selectedOptions).forEach(option => {
            // Check if the role already exists in the selected roles
            if (!document.getElementById(`role-${option.value}`)) {
                // Create a role box
                const roleBox = document.createElement('span');
                roleBox.classList.add('role-box');
                roleBox.id = `role-${option.value}`;
                roleBox.innerHTML = `
                    ${option.value}
                    <span class="remove-role" onclick="removeRole('${option.value}')">✕</span>
                `;

                // Append the role box to the selected roles container
                selectedRolesContainer.appendChild(roleBox);

                // Create a hidden input for the role
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'roles';
                hiddenInput.value = option.value;
                hiddenInput.id = `input-role-${option.value}`;

                // Append the hidden input to the form
                selectedRolesContainer.appendChild(hiddenInput);
            }
        });

        updateAvailableRoles(); // Update the dropdown after adding roles
        hideModal('rolesModal'); // Hide the modal
    }


    function removeRole(role) {
    console.log('removing role: ' + role);

        // Remove the role box and corresponding hidden input
        const roleBox = document.getElementById(`role-${role}`);
        const hiddenInput = document.getElementById(`input-role-${role}`);
        if (roleBox) roleBox.remove();
        if (hiddenInput) hiddenInput.remove();

        // Enable the removed role in the dropdown
        const availableRoles = document.getElementById('availableRoles');
        const optionToEnable = Array.from(availableRoles.options).find(option => option.value === role);
        if (optionToEnable) {
            optionToEnable.disabled = false;
            optionToEnable.style.color = ''; // Reset style for enabled option
        }
    }
                    // Show Modal
                    function showModal(modalId) {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.remove('hidden');
                            modal.classList.add('visible');
                        }
                    }

                    // Hide Modal
                    function hideModal(modalId) {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.remove('visible');
                            modal.classList.add('hidden');
                        }
                    }
                    document.addEventListener('DOMContentLoaded', () => {
                        updateAvailableRoles(); // Ensure dropdown is updated on page load
                    });
        </script>
        <script>
            function addSelectedRoleAndSubmit() {
                const availableRoles = document.getElementById('availableRoles');
                const selectedRolesContainer = document.getElementById('selectedRoles');
                const form = document.querySelector('#systemuserform');

                // Flag to track if duplicates are found
                let duplicatesFound = false;

                // Iterate over selected options in the roles dropdown
                Array.from(availableRoles.selectedOptions).forEach(option => {
                    // Check if the role already exists in the selected roles
                    if (!document.getElementById(`role-${option.value}`)) {
                        // Create a role box
                        const roleBox = document.createElement('span');
                        roleBox.classList.add('role-box');
                        roleBox.id = `role-${option.value}`;
                        roleBox.innerHTML = `
                            ${option.value}
                            <span class="remove-role" onclick="removeRole('${option.value}')">✕</span>
                        `;

                        // Append the role box to the selected roles container
                        selectedRolesContainer.appendChild(roleBox);

                        // Create a hidden input for the role
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'roles';
                        hiddenInput.value = option.value;
                        hiddenInput.id = `input-role-${option.value}`;

                        // Append the hidden input to the form
                        selectedRolesContainer.appendChild(hiddenInput);
                    } else {
                        // If a duplicate role is found, set the flag
                        duplicatesFound = true;
                    }
                });

                if (duplicatesFound) {
                    alert('Some selected roles were already added and were ignored to avoid duplicates.');
                }

                // Hide the modal
                hideModal('rolesModal');

                // Submit the form
                form.submit();
            }
        </script>

<!--        This javascript makes a hidden element when somebody clicks on a role to delete -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const selectedRolesContainer = document.getElementById('selectedRoles');
                const form = document.getElementById('systemuserform');

                selectedRolesContainer.addEventListener('click', function (event) {
                    const target = event.target;

                    if (target.classList.contains('remove-role')) {
                        const role = target.getAttribute('data-role');

                        // Remove visual role display
                        const roleBox = document.getElementById(`role-${role}`);
                        const originalHiddenInput = document.getElementById(`input-role-${role}`);
                        if (roleBox) roleBox.remove();
                        if (originalHiddenInput) originalHiddenInput.remove();

                        // Add hidden input for deletion
                        const deleteInput = document.createElement('input');
                        deleteInput.type = 'hidden';
                        deleteInput.name = 'rolestodelete';
                        deleteInput.value = role;
                        form.appendChild(deleteInput);

                        // Submit the form
                        form.submit();
                    }
                });
            });
        </script>

        </tbody>

    </table>
    <!-- add pagination here -->
    <nav th:if="${systemuserPage.totalPages > 0}">
        <ul class="pagination flex-wrap justify-content-center">
            <li class="page-item" th:each="pageNumber : ${pageNumbers}">
                <a class="page-link btn btn-secondary btn-sm m-1"
                   th:href="@{/systemuser(size=${#lists.size(systemuserPage.content) > 5 ? #lists.size(systemuserPage.content) : 5}, page=${pageNumber})}"
                   th:text="${pageNumber}"
                   th:classappend="${pageNumber==systemuserPage.number + 1} ? 'active'">
                </a>
            </li>
        </ul>
    </nav>

</div>
</body>
</html>
