<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SystemUser Management</title>
    <!-- CSS and JavaScript dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for styling */
        body {
            font-family: 'Roboto', sans-serif;
        }
        .header-dark {
            background-color: #343a40;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .validation-error {
            color: red;
            font-size: 0.9em;
        }
        .is-invalid {
            border-color: red !important;
            box-shadow: 0 0 5px red !important;
        }
        .is-valid {
            border-color: green !important;
            box-shadow: 0 0 5px green !important;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');

            // Helper function to validate individual fields
            const validateField = (field, condition, errorMessage) => {
                const errorElement = field.nextElementSibling;
                if (!condition) {
                    field.classList.add('is-invalid');
                    field.classList.remove('is-valid');
                    errorElement.textContent = errorMessage;
                } else {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                    errorElement.textContent = '';
                }
            };

            // Event listeners for real-time validation
            const nameField = form.querySelector('input[name="name"]');
            nameField.addEventListener('input', () => {
                validateField(nameField, /^[A-Za-z\s]+$/.test(nameField.value), 'Name should contain only letters and spaces.');
            });

            const emailField = form.querySelector('input[name="email"]');
            emailField.addEventListener('input', () => {
                validateField(emailField, /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value), 'Invalid email format.');
            });

            const phoneField = form.querySelector('input[name="phone"]');
            phoneField.addEventListener('input', () => {
                phoneField.value = phoneField.value.replace(/\D/g, '').slice(0, 10);
                validateField(phoneField, phoneField.value.length === 10, 'Phone number must be exactly 10 digits.');
            });

            const passwordField = form.querySelector('input[name="password"]');
            const password2Field = form.querySelector('input[name="password2"]');
            passwordField.addEventListener('input', () => {
                validateField(passwordField, passwordField.value.length >= 6, 'Password must be at least 6 characters long.');
            });
            password2Field.addEventListener('input', () => {
                validateField(password2Field, passwordField.value === password2Field.value, 'Passwords do not match.');
            });

            // Form submit validation
            form.addEventListener('submit', function (e) {
                let isValid = true;
                const errors = document.querySelectorAll('.validation-error');
                errors.forEach(error => error.textContent = '');

                // Final validation check before submission
                validateField(nameField, /^[A-Za-z\s]+$/.test(nameField.value), 'Name should contain only letters and spaces.');
                validateField(emailField, /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value), 'Invalid email format.');
                validateField(phoneField, phoneField.value.length === 10, 'Phone number must be exactly 10 digits.');
                validateField(passwordField, passwordField.value.length >= 6, 'Password must be at least 6 characters long.');
                validateField(password2Field, passwordField.value === password2Field.value, 'Passwords do not match.');

                // Prevent form submission if invalid
                if (!form.querySelectorAll('.is-valid').length === form.querySelectorAll('input').length) {
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                }
            });
        });
    </script>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header-dark">
        <h1>System User Management</h1>
        <p>Manage System Users</p>
    </div>

    <!-- Form for SystemUserDAO -->
    <form th:action="@{${systemuser != null && systemuser.id > 0 ? '/systemuser/edit' : '/systemuser/create'}}" method="post" th:object="${systemuser}">
        <input type="hidden" th:field="*{id}">

        <div class="row">
            <!-- Name -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" th:field="*{name}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Email -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" th:field="*{email}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Phone -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Phone</label>
                <input type="text" class="form-control" th:field="*{phone}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Password -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Change Password</label>
                Coming soon
<!--                <input type="password" class="form-control" th:field="*{password}" required>-->
<!--                <span class="validation-error"></span>-->
            </div>

            <!-- Project -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Tenant</label>
                <input type="text" class="form-control" th:field="*{tenant}" required>
                <span class="validation-error"></span>
            </div>

            <!-- Roles -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Roles</label>
                <select multiple class="form-select" th:field="*{roles}" required>
                    <!-- Loop through all available roles -->
                    <option th:each="roleOption : ${allRoles}"
                            th:value="${roleOption}"
                            th:text="${roleOption}"
                            th:selected="${#arrays.contains(systemuser.roles, roleOption)}">
                    </option>
                </select>
                <span class="validation-error">Please select at least one role.</span>
            </div>


            <!-- User Active -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Is Active</label>
                <input type="checkbox" class="form-check-input" th:field="*{isuseractive}" value="1">
                <span class="validation-error"></span>
            </div>

            <!-- Created Timestamp -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Created Timestamp</label>
                <input type="text" class="form-control" th:field="*{createtimestamp}" readonly>
            </div>

            <!-- Updated Timestamp -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Updated Timestamp</label>
                <input type="text" class="form-control" th:field="*{updatedtimestamp}" readonly>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">
            <span th:text="${systemuser.id > 0 ? 'Update User' : 'Create User'}"></span>
        </button>
    </form>

    <!-- Users List -->
    <div class="header-dark mt-4">
        <h2>System Users</h2>
    </div>
    <table class="table table-hover">
        <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${systemuserPage.content}" th:unless="${user.deleted == 1}">
            <td th:text="${user.name}"></td>
            <td th:text="${user.email}"></td>
            <td th:text="${user.phone}"></td>
            <td>
                <a th:href="@{/systemuser(systemuserid=${user.id})}" class="btn btn-sm btn-warning">Edit</a>
                <form th:action="@{/systemuser/delete}" method="post" style="display:inline;">
                    <input type="hidden" name="id" th:value="${user.id}">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>
</body>
</html>
