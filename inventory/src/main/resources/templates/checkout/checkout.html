<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>

    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" media="all" href="/css/table.css" th:href="@{/css/table.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f1f8fa;
        }
        .table-dark thead {
            background-color: #343a40;
            color: #fff;
        }
        .btn-secondary, .btn-primary, .btn-dark-theme {
            color: #fff;
            background-color: #343a40;
            border-color: #343a40;
        }
        .btn-secondary:hover, .btn-primary:hover, .btn-dark-theme:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .form-control, .form-select {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
        }
        .form-control:focus, .form-select:focus {
            background-color: #343a40;
            color: #fff;
            border-color: #1d2124;
            box-shadow: none;
        }
        .header-dark {
            background-color: #343a40;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        .header-small {
            background-color: #343a40;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
            max-width: 400px;
            margin: 0 auto 15px auto;
            text-align: center;
        }
        .back-button {
            margin-right: 20px;
            font-size: 2rem;
        }
        .back-button a {
            color: #343a40;
            background-color: #fff;
            padding: 10px;
            border-radius: 50%;
            border: 2px solid #343a40;
        }
        .back-button a:hover {
            background-color: #23272b;
            color: #fff;
            border-color: #23272b;
        }
        .alert {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
        }
        .alert-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .alert-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .alert-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .pagination .page-link {
            color: #fff;  /* Changed to white */
            background-color: #343a40;
            border: 1px solid #343a40;
        }
        .pagination .page-link:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .pagination .active .page-link {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }
        .required:after {
            content: " *";
            color: red;
        }
        .form-label {
            color: #000;  /* Changed to black */
        }
        .notes-bubble {
            background-color: #f1f8fa;
            border: 1px solid #c0c0c0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .progress {
            flex: 1;
            margin-left: 20px;
        }
        .progress-bar {
            background-color: #6c757d;
        }
        .form-label {
            color: #000;  /* Changed to black */
        }
        .price-class {
            color: #000;  /* Changed to black */
        }
        .customer-name {
            color: #000;  /* Black color for customer name */
        }
        /* Make the checkbox larger */
        #quantityModeCheckbox {
            width: 25px;
            height: 25px;

        }

        /* Style the label: dark background with white text */
        .form-check-label {
            background-color: #343a40; /* Dark background */
            color: white;              /* White text */
            padding: 5px 10px;         /* Add some padding */
            border-radius: 5px;        /* Optional: round the corners */
        }

        /* Optionally, adjust the label's appearance when the checkbox is focused */
        #quantityModeCheckbox:focus + .form-check-label {
            outline: 2px solid white;  /* Add an outline to the label when checkbox is focused */
        }

        .btn-dark-custom {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .btn-dark-custom:hover {
            background-color: #1d2124; /* Darker shade on hover */
            color: #f8f9fa; /* Lighter text on hover */
        }
    </style>

    <script>
        $(document).ready(function () {
            $('#barcodeInput').focus();

            $('#customerselectid').on('change', function() {
                if ($('#barcodeInput').val().trim() === '') {
                    $('#barcodeInput').focus();
                }
            });

        const inputField = document.getElementById('barcodeInput');
        let inputTimeout;

        // Listen for input event
        inputField.addEventListener('input', function() {
            clearTimeout(inputTimeout);

            // Delay processing to ensure the entire scan input is captured
            inputTimeout = setTimeout(() => {
                const scannedValue = inputField.value.trim();
                const ischecked = $('#quantityModeCheckbox').is(':checked'); // Re-check within the timeout

                if (scannedValue) {
                    processBarcode(scannedValue, ischecked);
                    inputField.value = ''; // Clear after processing
                }
            }, 200); // Adjust delay based on scan speed, if needed
        });

        // Optional: Prevent Enter key from submitting the form or adding duplicate inputs
        inputField.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission or duplicate entry
            }
        });

            // Add event listener to the checkbox
            $('#quantityModeCheckbox').on('click', function() {
                // Refocus on the barcode input field when the checkbox is clicked
                $('#barcodeInput').focus();
            });

            // Function to process barcode scanning
            function processBarcode(scannedValue, ischecked) {
                if (scannedValue.length >= 12) {
                    if (ischecked) {
                        // If Quantity Mode is checked, ask for quantity input
                        let quantity = prompt("Please enter the quantity for the scanned product:");

                        if (quantity !== null && quantity !== "") {
                            // Set quantity in the hidden input
                            $('#quantitySelected').val(quantity);
                            $('#barcodeInput').val(scannedValue.substring(0, 12));
                            $('#barcodeForm').submit();
                        }
                    } else {
                        // If not in Quantity Mode, just submit the form with quantity 1
                        $('#barcodeInput').val(scannedValue.substring(0, 12));
                        $('#quantitySelected').val(1);
                        $('#barcodeForm').submit();
                    }
                }
            }

            function focusInputAfterDelay(selector, delay) {
                setTimeout(function() {
                    $(selector).focus();
                }, delay);
            }

            focusInputAfterDelay('#barcodeInput', 100);

            $('#barcodeInput').on('input', function () {
                if ($(this).val().trim() !== '') {
                    $('#submitTransactionForm button').prop('disabled', true);
                } else {
                    $('#submitTransactionForm button').prop('disabled', false);
                }
            });

            // Disable the review cart button if there are no rows in the table
            const reviewCartButton = $('#submitTransactionForm button');
            const tableRows = $('#barcodeForm tbody tr');
            if (tableRows.length === 0) {
                reviewCartButton.prop('disabled', true);
            } else {
                reviewCartButton.prop('disabled', false);
            }
        });

        function deleteItemFromCart(element) {
            event.preventDefault();
            const barcode = element.closest('tr').getAttribute('data-barcode');
            const form = document.getElementById('deleteItemFromCartForm');

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'barcode';
            hiddenInput.value = barcode;
            form.appendChild(hiddenInput);

            form.submit();
        }
    </script>

    <!-- CSS for Popup -->
    <style>
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
        }
        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-popup {
        color: black;
            position: absolute;
            top: 1px;
            right: 15px;
            font-size: 40px;
            cursor: pointer;
        }
    </style>

    <script>
        function copyToClipboard(buttonElement) {
            // Get the value from the data-barcode attribute
            var barcodeValue = buttonElement.getAttribute('data-barcode');
            var productNameValue = buttonElement.getAttribute('data-productname');

            // Copy to clipboard (assuming you've already implemented this logic)
            var tempInput = document.createElement('input');
            tempInput.value = barcodeValue;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);

            // Provide feedback (optional)
            alert("Copied: " + barcodeValue + " | " + productNameValue);
        }

    </script>

</head>
<body>
<div th:insert="auth/navbar.html :: navbarfragment"></div>
<div class="container">
    <div class="header-dark">
        <div class="back-button">
            <a th:href="@{/dashboard/index}"><i class="bi bi-arrow-left-circle"></i></a>
        </div>
        <div class="col-md-6">
            <h1>Checkout</h1>
            <p>Scan Products to Checkout</p>
        </div>
        <div class="col-md-6">
            <h3>Total Units:
                <span th:text="${cart.displayquantitytotal}"></span>
            </h3>
        </div>
    </div>
    <br>
    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">Error</div>
    <div class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">Success</div>

    <form id="barcodeForm" th:action="@{/checkout/scan?cartid=__${cart.cartid != null ? cart.cartid : '0'}__}" th:object="${cart}" method="post">
        <div class="row">
            <div class="col-md-8">
                <div class="row" style="margin-bottom: 5px;">
                    <div class="col-md-6" style="margin-bottom: 5px;">
                        <input id="barcodeInput" type="text" th:field="*{barcode}" class="form-control" placeholder="barcode" aria-label="barcode">
                    </div>
                    <div class="col-md-6">
                        <!-- Quantity Mode Checkbox -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="quantityModeCheckbox">
                            <label class="form-check-label" for="quantityModeCheckbox">Quantity Mode</label>
                        </div>
                    </div>
                    <!-- Add this inside the form containing "Quantity Mode" -->
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col-md-6">
                            <button id="searchProductBtn" class="btn btn-warning">Search For Product</button>
                        </div>
                    </div>

                </div>
                <div class="row" style="margin-bottom: 5px;">
                    <div class="col-md-6" style="margin-bottom: 5px;">
                        <div th:if="${cart.cartid}">
                            <p th:each="customer : ${customers}" th:if="${customer.customerid == cart.customer.customerid}" th:text="${customer.name}" class="customer-name">Customer Name</p>
                            <input type="hidden" th:field="*{customer.customerid}">
                        </div>
                        <div th:if="${cart.cartid == 0}">
                            <select class="form-control" th:field="${cart.customer.customerid}" id="customerselectid">
                                <option value="" selected="selected">Select a customer</option>
                                <option th:each="customer : ${customers}" th:value="${customer.customerid}" th:text="${customer.name}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: 5px;">
                    <div class="col-md-6" style="margin-bottom: 5px;">
                        <label class="form-label"><b>Total Price</b></label>
                        <input type="hidden" th:field="*{total}" class="form-control" placeholder="total" aria-label="total" readonly>
                        <p class="form-control" th:text="${cart.total}"></p>
                    </div>
                    <input type="hidden" th:field="*{isprocessed}">
                    <input type="hidden" th:field="*{updateTimeStamp}">
                    <input type="hidden" th:field="*{createTimeStamp}">
                </div>
                <button style="margin-top: 5px;visibility: hidden;" type="submit" class="btn btn-primary">Submit</button>
            </div>
            <div class="col-md-4">
                <div style="overflow-x: auto;">
                    <table class="table table-hover table-striped table-dark">
                        <thead>
                        <tr>
                            <th>Item</th>
                            <th>Price</th>
                            <th>Quantity</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${cart.product_cart_list}" th:data-barcode="${item.barcode}">
                            <td th:text="${item.name}" data-barcode="${item.barcode}">Item Name</td>
                            <td th:text="${item.price}">Price</td>
                            <td th:text="${item.displayquantity}">Quantity</td>
                            <td>
                                <a id="deleteItemID" href="#" onclick="deleteItemFromCart(this)">X</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <input type="hidden" th:field="*{product_cart_list}">
                    <input type="hidden" id="quantitySelected" th:field="*{quantityselected}" name="quantityselected">
                </div>
            </div>
        </div>
    </form>

    <form id="deleteItemFromCartForm" th:action="@{/checkout/delete?cartid=__${cart.cartid}__}" th:object="${cart}" method="post">
        <input type="hidden" name="_method" value="delete" />
    </form>

    <form id="submitTransactionForm" th:action="@{/checkout/reviewcart?cartid=__${cart.cartid != null ? cart.cartid : '0'}__}" th:object="${cart}" method="post">
        <input type="hidden" th:field="*{product_cart_list}">
        <input type="hidden" th:field="*{customer.customerid}">
        <button style="margin-top: 5px;" type="submit" class="btn btn-dark-theme">Review Cart</button>
    </form>


    <!-- This table will display with product info based on case insensitive search from popup -->
    <div class="col-md-8" th:if="${productPage != null && productPage.content.size() > 0}">
        <table class="table table-hover table-striped table-dark" style="margin-top: 20px">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Barcode</th>
                <th scope="col">Product Name</th>
                <th scope="col">Quantity</th>
                <th scope="col">Quantity Remaining</th>
                <th scope="col">Price</th>
                <th scope="col">Batch Name</th>
                <th scope="col">Batch ID</th>
                <th scope="col">Create Date</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product, iStat : ${productPage.content}"
                th:style="${iStat.odd}? 'font-weight: bold;'"
                th:alt-title="${iStat.even}? 'even' : 'odd'">
                <td th:text="${product.product_id}"></td>
                <td>
                    <span th:text="${product.barcode}"></span>
                    <!-- Button to copy barcode -->
                    <button type="button" class="btn btn-dark-custom btn-sm"
                            onclick="copyToClipboard(this)"
                            th:data-barcode="${product.barcode}"
                            th:data-productname="${product.name}"
                    >
                        Copy
                    </button>
                </td>
                <td th:text="${product.name}"></td>
                <td th:text="${product.quantity}"></td>
                <td th:text="${product.quantityremaining}"></td>
                <td th:text="${product.price}"></td>
                <td th:text="${product.batch.name}"></td>
                <td th:text="${product.batch.batchid}"></td>
                <td th:text="${product.createTimeStamp}"></td>
            </tr>
            </tbody>
        </table>
        <nav th:if="${productPage.totalPages > 0}">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:each="pageNumber : ${pageNumbers}">
                    <a class="page-link btn btn-secondary btn-sm mx-1"
                       th:href="@{/checkout/searchByProductName?size=__${#lists.size(productPage.content) > 5 ? #lists.size(productPage.content) : 5}__&page=__${pageNumber}__&cartid=__${cart != null ? cart.cartid : '0'}__&productnamesearch=__${productNameSearchValue}__}"
                       th:text="${pageNumber}"
                       th:classappend="${pageNumber==productPage.number + 1} ? 'active'">
                    </a>
                </li>
            </ul>
        </nav>
    </div>

</div>





<!-- Custom Popup for Search -->
<div id="customPopup" class="popup-overlay">
    <div class="popup-content">
        <span class="close-popup">&times;</span>
        <h5 style="color: black;" class="modal-title">Search Product</h5>
        <form id="searchForProductNameForm" th:action="@{/checkout/searchByProductName?cartid=__${cart.cartid != null ? cart.cartid : '0'}__}" method="post">
            <input type="text" id="searchInput" name="productnamesearch" class="form-control" placeholder="Enter product name">
            <button style="margin-top: 10px;" type="submit" id="searchButton" class="btn btn-primary">Search</button>
        </form>
    </div>
</div>


<!-- JavaScript to Handle Popup For Search For Product Button -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const popup = document.getElementById("customPopup");
        const searchBtn = document.getElementById("searchProductBtn");
        const closeBtn = document.querySelector(".close-popup");

        searchBtn.addEventListener("click", function (e) {
            e.preventDefault();
            popup.style.display = "flex";
        });

        closeBtn.addEventListener("click", function () {
            popup.style.display = "none";
            focusInputAfterDelay('#barcodeInput', 100);
        });

        document.getElementById("searchButton").addEventListener("click", function () {
            let searchQuery = document.getElementById("searchInput").value.trim();
<!--            if (searchQuery) {-->
<!--                alert("Searching for: " + searchQuery); // Replace this with actual search logic-->
<!--            }-->
        });

        // Close popup when clicking outside the content
        window.addEventListener("click", function (e) {
            if (e.target === popup) {
                popup.style.display = "none";
                focusInputAfterDelay('#barcodeInput', 100);
            }
        });


        function focusInputAfterDelay(selector, delay) {
            setTimeout(function() {
                $(selector).focus();
            }, delay);
        }


    });
</script>




</body>
</html>
