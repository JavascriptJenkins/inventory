<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Package</title>

    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" media="all" href="/css/table.css" th:href="@{/css/table.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f1f8fa;
        }
        .table-dark thead {
            background-color: #343a40;
            color: #fff;
        }
        .btn-secondary, .btn-primary, .btn-dark-theme {
            color: #fff;
            background-color: #343a40;
            border-color: #343a40;
        }
        .btn-secondary:hover, .btn-primary:hover, .btn-dark-theme:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .form-control, .form-select {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
        }
        /* Increase specificity by adding more selectors */
        select.form-control,
        select.form-control option,
        .form-control:focus,
        .form-select:focus {
            background-color: #343a40 !important; /* Use !important to force override */
            color: #fff !important;
            border: 1px solid #343a40 !important;
            box-shadow: none !important;
        }

        /* Ensure option elements inherit the background */
        select.form-control option {
            background-color: #343a40 !important;
            color: #fff !important;
        }
        .header-dark {
            background-color: #343a40;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        .header-small {
            background-color: #343a40;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
            max-width: 400px;
            margin: 0 auto 15px auto;
            text-align: center;
        }
        .back-button {
            margin-right: 20px;
            font-size: 2rem;
        }
        .back-button a {
            color: #343a40;
            background-color: #fff;
            padding: 10px;
            border-radius: 50%;
            border: 2px solid #343a40;
        }
        .back-button a:hover {
            background-color: #23272b;
            color: #fff;
            border-color: #23272b;
        }
        .alert {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
        }
        .alert-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .alert-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .alert-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-submit-dark {
            font-size: 1.2rem;
            background-color: #444;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            border: 2px solid #343a40;
            display: inline-block;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }
        .headerbutton{
            border-color: #fff;
        }
        .btn-submit-dark:hover {
            background-color: #333;
            border-color: #23272b;
        }
        .pagination .page-link {
            color: #fff;
            background-color: #343a40;
            border: 1px solid #343a40;
        }
        .pagination .page-link:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .pagination .active .page-link {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }
        .required:after {
            content: " *";
            color: red;
        }
        .form-label {
            color: #000;
        }
        .notes-bubble {
            background-color: #f1f8fa;
            border: 1px solid #c0c0c0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .progress {
            flex: 1;
            margin-left: 20px;
        }
        .progress-bar {
            background-color: #6c757d;
        }
        .price-class {
            color: #000;
        }
        .producttype-name {
            color: #000;
        }
        /* Make the checkbox larger */
        #quantityModeCheckbox {
            width: 25px;
            height: 25px;

        }

        /* Style the label: dark background with white text */
        .form-check-label {
            background-color: #343a40; /* Dark background */
            color: white;              /* White text */
            padding: 5px 10px;         /* Add some padding */
            border-radius: 5px;        /* Optional: round the corners */
        }

        /* Optionally, adjust the label's appearance when the checkbox is focused */
        #quantityModeCheckbox:focus + .form-check-label {
            outline: 2px solid white;  /* Add an outline to the label when checkbox is focused */
        }
    </style>

    <script>
        $(document).ready(function () {
            // Check if the input with id="packagename" has no value
            var packageNameInput = $('#packagename').val().trim();

            // Only show the popup if the packagename input is empty
            if (packageNameInput === '') {
                let packageName = prompt("Please enter the name of package you want to create (samplebox, iowa pallet, john's shipment etc):");

                // If the user provides input, set the value of the #packagename input
                if (packageName !== null && packageName.trim().length > 0) {
                    $('#packagename').val(packageName.trim());
                }
            }

            $('#barcodeInput').focus();

            $('#packagetypeselectid').on('change', function() {
                if ($('#barcodeInput').val().trim() === '') {
                    $('#barcodeInput').focus();
                }
            });

            $('#packagetypeselectid2').on('change', function() {
                if ($('#barcodeInput').val().trim() === '') {
                    $('#barcodeInput').focus();
                }
            });

            const inputField = document.getElementById('barcodeInput');

            inputField.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    const scannedValue = inputField.value.trim();
                    processBarcode(scannedValue);
                }
            });

            // Add event listener to the checkbox
            $('#quantityModeCheckbox').on('click', function() {
                // Refocus on the barcode input field when the checkbox is clicked
                $('#barcodeInput').focus();
            });


            // Function to process barcode scanning
            function processBarcode(scannedValue) {
                if (scannedValue.length >= 11) {
                    if ($('#quantityModeCheckbox').is(':checked')) {
                        // If Quantity Mode is checked, ask for quantity input
                        let quantity = prompt("Please enter the quantity for the scanned product:");

                        if (quantity !== null && quantity !== "") {
                            // Set quantity in the hidden input
                            $('#quantitySelected').val(quantity);
                            $('#barcodeInput').val(scannedValue.substring(0, 11));
                            $('#barcodeForm').submit();
                        }
                    } else {
                        // If not in Quantity Mode, just submit the form
                        $('#barcodeInput').val(scannedValue.substring(0, 11));
                        $('#barcodeForm').submit();
                    }
                }
            }

            function focusInputAfterDelay(selector, delay) {
                setTimeout(function() {
                    $(selector).focus();
                }, delay);
            }

            focusInputAfterDelay('#barcodeInput', 100);

            $('#barcodeInput').on('input', function () {
                if ($(this).val().trim() !== '') {
                    $('#submitTransactionForm button').prop('disabled', true);
                } else {
                    $('#submitTransactionForm button').prop('disabled', false);
                }
            });

            const reviewPackageButton = $('#submitTransactionForm button');
            const tableRows = $('#barcodeForm tbody tr');
            if (tableRows.length === 0) {
                reviewPackageButton.prop('disabled', true);
            } else {
                reviewPackageButton.prop('disabled', false);
            }
        });

        function deleteItemFromPackage(element) {
            event.preventDefault();
            const barcode = element.closest('tr').getAttribute('data-barcode');
            const form = document.getElementById('deleteItemFromPackageForm');

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'barcode';
            hiddenInput.value = barcode;
            form.appendChild(hiddenInput);

            form.submit();
        }
    </script>

</head>
<body>
<div th:insert="fragments/palletmodenavbar.html :: palletmodefragment"></div>
<div class="container">
    <div class="header-dark">
        <div class="back-button">
            <a th:href="@{/dashboard/index}"><i class="bi bi-arrow-left-circle"></i></a>
        </div>
        <div class="col-md-4">
            <h1>Package</h1>
            <p>Scan Products to add to Package</p>
        </div>
        <div class="col-md-4">
            <h3>Total Units:
                <span th:text="${package.displayquantitytotal}"></span>
            </h3>
            <h6>Package UPCA:
                <span th:text="${package.packagebarcode}"></span>
            </h6>
        </div>
        <div th:if="${deliveryid != null && deliveryid != 'null' && deliveryid != '0'}" class="col-md-4">
            <h3>
                <a class="btn btn-secondary headerbutton btn-lg" th:href="@{/delivery(deliveryid=${deliveryid})}"><span>Back to Delivery ></span></a>
            </h3>


        </div>


    </div>
    <br>
    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">Error</div>
    <div class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">Success</div>

    <form id="barcodeForm" th:action="@{/package/scan?packageid=__${package.packageid != null ? package.packageid : '0'}__&deliveryid=__${deliveryid != null ? deliveryid : 0}__}" th:object="${package}" method="post">
        <div class="row">
            <div class="col-md-8">
                <div class="row" style="margin-bottom: 5px;">
                    <div class="col-md-6" style="margin-bottom: 5px;">
                        <input id="barcodeInput" type="text" th:field="*{barcode}" class="form-control" placeholder="barcode" aria-label="barcode">
                    </div>
                    <div class="col-md-6">
                        <!-- Quantity Mode Checkbox -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="quantityModeCheckbox">
                            <label class="form-check-label" for="quantityModeCheckbox">Quantity Mode</label>
                        </div>
                    </div>
                </div>
                <div class="row col-md-6" style="margin-bottom: 5px;">
                    <div th:if="${package.packageid == 0}">
                        <label class="form-label required">Package Type</label>
                        <select id="packagetypeselectid" class="form-control" th:field="${package.packagetype}" readonly="">
                            <option th:each="packagetype : ${packagetypes}" th:value="${packagetype.packagetypeid}" th:text="${packagetype.name}"></option>
                        </select>
                    </div>
                    <div th:if="${package.packageid != 0}">
                        <label class="form-label required">Package Type</label>
                        <select id="packagetypeselectid2" class="form-control" th:field="${package.packagetype}">
                            <option th:each="packagetype : ${packagetypes}" th:value="${packagetype.packagetypeid}"
                                    th:text="${packagetype.name}"
                                    th:selected="${packagetype.packagetypeid == package.packagetype.packagetypeid}"></option>
                        </select>
                    </div>
                </div>

                <!-- todo: put the location and customer selection here
                 -->

                <div class="row" style="margin-bottom: 5px;">
                    <div class="col-md-6" style="margin-bottom: 5px;">
                        <label class="form-label"><b>Total Price</b></label>
                        <input type="hidden" th:field="*{total}" class="form-control" placeholder="total" aria-label="total" readonly>
                        <p class="form-control" th:text="${package.total}"></p>
                    </div>
                    <input type="hidden" th:field="*{isprocessed}">
                    <input type="hidden" th:field="*{weight}">
                    <input type="hidden" th:field="*{packagebarcode}">
                    <input type="hidden" th:field="*{updateTimeStamp}">
                    <input type="hidden" th:field="*{createTimeStamp}">
                </div>
                <div class="col-md-6" style="margin-bottom: 5px;">
                    <label class="form-label required">Package Name</label>
                    <input id="packagename" type="text" th:field="*{name}" class="form-control" placeholder="name" aria-label="name">
                </div>
                <button style="margin-top: 5px; visibility: hidden;" type="submit" class="btn btn-primary">Submit</button>
            </div>
            <div class="col-md-4">
                <div style="overflow-x: auto;">
                    <table id="itemTable" class="table table-hover table-striped table-dark">
                        <thead>
                        <tr>
                            <th>Item</th>
                            <th>Price</th>
                            <th>Quantity</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${package.product_package_list}" th:data-barcode="${item.barcode}">
                            <td th:text="${item.name}" data-barcode="${item.barcode}">Item Name</td>
                            <td th:text="${item.price}">Price</td>
                            <td th:text="${item.displayquantity}">Quantity</td>
                            <td>
                                <a id="deleteItemID" href="#" onclick="deleteItemFromPackage(this)">X</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <input type="hidden" th:field="*{product_package_list}">
                    <input type="hidden" id="quantitySelected" th:field="*{quantityselected}" name="quantityselected">
                </div>
            </div>
        </div>
    </form>

    <form id="deleteItemFromPackageForm" th:action="@{/package/delete?packageid=__${package.packageid}__&deliveryid=__${deliveryid != null ? deliveryid : 0}__}" th:object="${package}" method="post">
        <input type="hidden" name="_method" value="delete" />
    </form>

    <form id="submitTransactionForm" th:action="@{/package/reviewpackage?packageid=__${package.packageid != null ? package.packageid : '0'}__}" th:object="${package}" method="post">
        <input type="hidden" th:field="*{product_package_list}">
<!--        <input type="hidden" th:field="*{packagetype.packgetypeid}">-->
        <input type="hidden" th:field="*{packagetype.packagetypeid}">
        <input type="hidden" th:field="*{name}">
<!--        <button style="margin-top: 5px;" type="submit" class="btn btn-dark-theme">Review Package</button>-->
    </form>

    <a th:if="${package.crate == null }" style="margin-top: 5px;" th:href="@{/crate?packageid=__${package.packageid}__&crateid=0}" class="btn-submit-dark">New Crate</a>
    <a th:if="${package.crate == null }" style="margin-top: 5px;" th:href="@{/crate/pendingcrates}" class="btn-submit-dark">Assign to Existing Crate</a>
    <a th:if="${package.crate != null && deliveryid == null}" style="margin-top: 5px;" th:href="@{/crate?packageid=__${package.packageid}__&crateid=__${package.crate.crateid}__}" class="btn-submit-dark">Crate</a>
</div>
</body>
</html>
