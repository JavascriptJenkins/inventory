<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>METRC Documentation Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .document-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        
        .document-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-file-earmark-text"></i>
                    METRC Documentation Management
                </h1>
                
                <!-- Status Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            System Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-primary" th:text="${documentCount}">0</h3>
                                    <p class="text-muted">Documents Indexed</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-success" th:text="${folderPath}">uploads/metrcdocs</h3>
                                    <p class="text-muted">Storage Location</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-outline-primary me-2" onclick="reindexDocuments()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Reindex Documents
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="refreshStatus()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Refresh Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-cloud-upload"></i>
                            Upload Documents
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="bi bi-cloud-upload fs-1 text-muted mb-3"></i>
                            <h5>Drag & Drop files here</h5>
                            <p class="text-muted">or click to select files</p>
                            <input type="file" id="fileInput" multiple accept=".txt,.md,.pdf,.doc,.docx" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                <i class="bi bi-folder2-open"></i>
                                Select Files
                            </button>
                        </div>
                        <div id="uploadProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="uploadStatus">Uploading...</small>
                        </div>
                    </div>
                </div>

                <!-- Documents List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-files"></i>
                            Indexed Documents
                        </h5>
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search documents...">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchDocuments()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="documentsList">
                            <div th:if="${documents.empty}" class="text-center text-muted py-4">
                                <i class="bi bi-folder2 fs-1"></i>
                                <p class="mt-2">No documents found. Upload some files to get started!</p>
                            </div>
                            
                            <div th:each="doc : ${documents}" class="document-item">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h6 class="mb-1" th:text="${doc.fileName}">Document Name</h6>
                                        <small class="text-muted" th:text="${doc.filePath}">File Path</small>
                                    </div>
                                    <div class="col-md-3">
                                                <small class="text-muted">
            Modified: <span th:text="${#dates.format(new java.util.Date(doc.lastModified), 'MMM dd, yyyy HH:mm')}">Date</span>
        </small>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <button class="btn btn-sm btn-outline-danger delete-doc-btn" th:data-document-id="${doc.id}">
                                            <i class="bi bi-trash"></i>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            uploadFiles(files);
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            uploadFiles(e.target.files);
        });

        function uploadFiles(files) {
            if (files.length === 0) return;

            uploadProgress.style.display = 'block';
            uploadStatus.textContent = 'Uploading...';

            Array.from(files).forEach((file, index) => {
                const formData = new FormData();
                formData.append('file', file);

                fetch('/metrcdocs/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        uploadStatus.textContent = `Uploaded: ${file.name}`;
                        setTimeout(() => {
                            refreshStatus();
                        }, 1000);
                    } else {
                        uploadStatus.textContent = `Error: ${data.error}`;
                    }
                })
                .catch(error => {
                    uploadStatus.textContent = `Error: ${error.message}`;
                });
            });
        }

        function reindexDocuments() {
            fetch('/metrcdocs/reindex', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Documents reindexed successfully!');
                    refreshStatus();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        function deleteDocument(documentId) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }

            fetch(`/metrcdocs/document/${documentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Document deleted successfully!');
                    refreshStatus();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        function searchDocuments() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) {
                refreshStatus();
                return;
            }

            fetch(`/metrcdocs/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayDocuments(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        function displayDocuments(documents) {
            const documentsList = document.getElementById('documentsList');
            
            if (documents.length === 0) {
                documentsList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search fs-1"></i>
                        <p class="mt-2">No documents found matching your search.</p>
                    </div>
                `;
                return;
            }

            documentsList.innerHTML = documents.map(doc => `
                <div class="document-item">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1">${doc.fileName}</h6>
                            <small class="text-muted">${doc.filePath}</small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                Modified: ${new Date(doc.lastModified).toLocaleString()}
                            </small>
                        </div>
                                                 <div class="col-md-3 text-end">
                             <button class="btn btn-sm btn-outline-danger delete-doc-btn" data-document-id="${doc.id}">
                                 <i class="bi bi-trash"></i>
                                 Delete
                             </button>
                         </div>
                    </div>
                </div>
            `).join('');
        }

        function refreshStatus() {
            fetch('/metrcdocs/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector('.text-primary').textContent = data.documentCount;
                    displayDocuments(data.documents);
                }
            })
            .catch(error => {
                console.error('Error refreshing status:', error);
            });
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchDocuments();
            }
        });

        // Handle delete button clicks using event delegation
        document.addEventListener('click', (e) => {
            if (e.target.closest('.delete-doc-btn')) {
                const button = e.target.closest('.delete-doc-btn');
                const documentId = button.getAttribute('data-document-id');
                deleteDocument(documentId);
            }
        });
    </script>
</body>
</html>
