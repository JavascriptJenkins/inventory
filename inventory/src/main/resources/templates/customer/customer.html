<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Customer Management</title>
    <!-- Bootstrap CSS or your existing CSS -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" media="all" href="/css/table.css" th:href="@{/css/table.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f1f8fa;
        }
        .table-dark thead {
            background-color: #343a40;
            color: #fff;
        }
        .btn-secondary, .btn-primary {
            color: #fff;
            background-color: #343a40;
            border-color: #343a40;
        }
        .btn-secondary:hover, .btn-primary:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .form-control, .form-select {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
        }
        .form-control:focus, .form-select:focus {
            background-color: #343a40;
            color: #fff;
            border-color: #1d2124;
            box-shadow: none;
        }
        .header-dark {
            background-color: #343a40;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        .header-small {
            background-color: #343a40;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
            max-width: 400px;
            margin: 0 auto 15px auto;
            text-align: center;
        }
        .back-button {
            margin-right: 20px;
            font-size: 2rem;
        }
        .back-button a {
            color: #343a40;
            background-color: #fff;
            padding: 10px;
            border-radius: 50%;
            border: 2px solid #343a40;
        }
        .back-button a:hover {
            background-color: #23272b;
            color: #fff;
            border-color: #23272b;
        }
        .alert {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
        }
        .alert-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .alert-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .alert-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .pagination .page-link {
            color: #fff;  /* Changed to white */
            background-color: #343a40;
            border: 1px solid #343a40;
        }
        .pagination .page-link:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .pagination .active .page-link {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }
        .required:after {
            content: " *";
            color: red;
        }
        .form-label {
            color: black;  /* Changed to black */
        }
    </style>
    <script>
        function validateInput(data) {
            const namePattern = /^[A-Za-z\s]+$/;
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phonePattern = /^\+?[0-9\s\-\(\)]+$/;
            const addressPattern = /^[A-Za-z0-9\s,.'-]{3,}$/;
            const notesPattern = /^[A-Za-z0-9\s,.!?'"@#$%^&*()_+\-=\[\]{};:\\|<>\/`~]{1,256}$/;

            const errors = {};

            if (!namePattern.test(data.name)) {
                errors.name = 'Invalid name. Only letters and spaces are allowed.';
            }

            if (!emailPattern.test(data.email)) {
                errors.email = 'Invalid email address.';
            }

            if (!phonePattern.test(data.phone)) {
                errors.phone = 'Invalid phone number.';
            }

            if (!addressPattern.test(data.address)) {
                errors.address = 'Invalid address.';
            }

            if (data.address2 && !addressPattern.test(data.address2)) {
                errors.address2 = 'Invalid secondary address.';
            }

            if (data.notes.length > 256 || !notesPattern.test(data.notes) || /<script>|<\/script>|SELECT|INSERT|DELETE|UPDATE|DROP|ALTER|--/.test(data.notes)) {
                errors.notes = 'Invalid notes. Ensure it does not contain script or SQL injection attempts, and is under 256 characters.';
            }

            return {
                isValid: Object.keys(errors).length === 0,
                errors: errors
            };
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('customerForm');
            const errorMessageDiv = document.querySelector('.alert-danger');
            const successDiv = document.getElementById('successDiv');
            const submitButton = document.getElementById('customerSubmitButton');
            const createAnotherButton = document.getElementById('createAnotherButton');

            if (successDiv && successDiv.textContent.trim() !== '') {
                submitButton.disabled = true;
                createAnotherButton.style.display = 'inline-block';
            }

            form.addEventListener('submit', function (event) {
                event.preventDefault();

                const formData = {
                    name: form.querySelector('input[name="name"]').value,
                    email: form.querySelector('input[name="email"]').value,
                    phone: form.querySelector('input[name="phone"]').value,
                    address: form.querySelector('input[name="address"]').value,
                    address2: form.querySelector('input[name="address2"]').value,
                    notes: form.querySelector('input[name="notes"]').value
                };

                const validationResult = validateInput(formData);

                if (!validationResult.isValid) {
                    errorMessageDiv.style.display = 'block';
                    errorMessageDiv.innerHTML = Object.values(validationResult.errors).join('<br>');
                } else {
                    errorMessageDiv.style.display = 'none';
                    form.submit();
                }
            });

            createAnotherButton.addEventListener('click', function () {
                console.log('Create Another Customer button clicked');

                const nameInput = form.querySelector('input[name="name"]');
                const emailInput = form.querySelector('input[name="email"]');
                const phoneInput = form.querySelector('input[name="phone"]');
                const addressInput = form.querySelector('input[name="address"]');
                const address2Input = form.querySelector('input[name="address2"]');
                const notesInput = form.querySelector('input[name="notes"]');

                if (nameInput) {
                    nameInput.value = '';
                    console.log('Name input cleared');
                }
                if (emailInput) {
                    emailInput.value = '';
                    console.log('Email input cleared');
                }
                if (phoneInput) {
                    phoneInput.value = '';
                    console.log('Phone input cleared');
                }
                if (addressInput) {
                    addressInput.value = '';
                    console.log('Address input cleared');
                }
                if (address2Input) {
                    address2Input.value = '';
                    console.log('Address2 input cleared');
                }
                if (notesInput) {
                    notesInput.value = '';
                    console.log('Notes input cleared');
                }

                submitButton.disabled = false;
                createAnotherButton.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
            });
        });
    </script>
</head>
<body>
<div th:insert="fragments/adminnavbar.html :: adminnavbarfragment"> </div>
<div class="container">
    <!-- Header -->
    <div class="header-dark">
        <div class="back-button">
            <a th:href="@{/admin}"><i class="bi bi-arrow-left-circle"></i></a>
        </div>

        <div>
            <h1>Customer</h1>
            <p>Create and manage customers.</p>
        </div>
    </div>

    <!-- Alert Messages -->
    <div class="alert alert-danger" role="alert" style="display: none;"></div>

    <div id="successDiv" class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">
        Success
    </div>

    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">
        Error
    </div>

    <!-- Customer Form -->
    <form th:action="@{${customer != null && customer.customerid > 0 ? '/customer/edit' : '/customer/create'}}" method="post" th:object="${customer}">
        <!-- Hidden ID field -->
        <input type="hidden" th:field="*{customerid}">

        <div class="row" style="margin-bottom: 5px;">
            <!-- Name Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" th:field="*{name}" required>
            </div>

            <!-- Email Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" th:field="*{email}">
            </div>

            <!-- Phone Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" th:field="*{phone}">
            </div>

            <!-- Address Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" th:field="*{address}">
            </div>

            <!-- Address2 Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Address 2</label>
                <input type="text" class="form-control" th:field="*{address2}">
            </div>

            <!-- City Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">City</label>
                <input type="text" class="form-control" th:field="*{city}">
            </div>

            <!-- State Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">State</label>
                <input type="text" class="form-control" th:field="*{state}">
            </div>

            <!-- Zip Code Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Zip Code</label>
                <input type="text" class="form-control" th:field="*{zipcode}">
            </div>

            <!-- Notes Field -->
            <div class="col-md-4" style="margin-bottom: 5px;">
                <label class="form-label">Notes</label>
                <textarea class="form-control" th:field="*{notes}"></textarea>
            </div>
        </div>

        <!-- Form Action Buttons -->
        <div class="form-actions">
            <!-- Submit Button (Dynamic Text) -->
            <button type="submit" class="btn btn-primary">
                <span th:text="${customer.customerid > 0 ? 'Update Customer' : 'Create Customer'}"></span>
            </button>

            <!-- Create Another Button -->
            <button type="button" onclick="window.location.href='/customer'" class="btn btn-secondary">
                Create Another Customer
            </button>
        </div>
    </form>

    <!-- Customers List Section -->
    <div class="header-small mt-4">Customers</div>
    <table class="table">
        <thead>
        <tr>
            <th>Name</th>
            <th>Notes</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="customer : ${customerPage.content}" th:unless="${customer.deleted == 1}">
            <td>
                <a th:href="@{/customer/get(customerid=${customer.customerid}, page=${customerPage.number + 1})}"
                   th:text="${customer.name}">
                </a>
            </td>
            <td th:text="${customer.notes}"></td>
            <td>
                <form th:action="@{/customer/delete}" method="post" style="display:inline;">
                    <input type="hidden" name="customerid" th:value="${customer.customerid}">
                    <button type="submit" class="btn btn-sm btn-danger"
                            onclick="return confirm('Are you sure you want to delete this customer?')">
                        Delete
                    </button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
    <nav th:if="${customerPage.totalPages > 0}">
        <ul class="pagination flex-wrap justify-content-center">
            <li class="page-item" th:each="pageNumber : ${pageNumbers}">
                <a class="page-link m-1"
                   th:href="@{/customer(size=${#lists.size(customerPage.content)}, page=${pageNumber})}"
                   th:text="${pageNumber}"
                   th:classappend="${pageNumber==customerPage.number + 1} ? 'active'">
                </a>
            </li>
        </ul>
    </nav>
</div>
</body>
</html>