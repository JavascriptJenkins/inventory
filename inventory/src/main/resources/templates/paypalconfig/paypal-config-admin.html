<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>PayPal API Configuration</title>

    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" media="all" href="/css/table.css" th:href="@{/css/table.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Bundle JS (Includes Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        .glowing-valid {
            box-shadow: 0 0 8px 2px #00ffff !important;
        }
        .glowing-invalid {
            box-shadow: 0 0 8px 2px #ff0000 !important;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f1f8fa;
        }
        .table-dark thead {
            background-color: #343a40;
            color: #fff;
        }
        .btn-secondary {
            color: #fff;
            background-color: #343a40;
            border-color: #343a40;
        }
        .btn-secondary:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .header-dark {
            background-color: #343a40;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        .config-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .config-header {
            background-color: #0070ba;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .form-control:focus {
            border-color: #0070ba;
            box-shadow: 0 0 0 0.2rem rgba(0, 112, 186, 0.25);
        }
        .btn-primary {
            background-color: #0070ba;
            border-color: #0070ba;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .alert {
            border-radius: 5px;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .required {
            color: #dc3545;
        }
    </style>
</head>
<body>
<div th:insert="~{fragments/adminnavbar.html :: adminnavbarfragment}"> </div>

    <div class="container-fluid">
        <div class="header-dark">
            <h1><i class="bi bi-paypal"></i> PayPal API Configuration</h1>
            <p class="mb-0">Manage PayPal API settings for SANDBOX and PROD environments</p>
        </div>

        <!-- Success/Error Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- SANDBOX Configuration -->
        <div class="config-section">
            <div class="config-header">
                <h4><i class="bi bi-cloud-sandbox"></i> SANDBOX Environment Configuration</h4>
            </div>
            
            <form th:action="@{/paypal-config/save-sandbox}" method="post" th:object="${sandboxConfig}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sandboxClientId" class="form-label">Client ID <span class="required">*</span></label>
                            <input type="text" class="form-control" id="sandboxClientId" name="clientId" 
                                   th:value="${sandboxConfig?.clientId}" placeholder="Enter SANDBOX Client ID" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sandboxClientSecret" class="form-label">Client Secret <span class="required">*</span></label>
                            <input type="password" class="form-control" id="sandboxClientSecret" name="clientSecret" 
                                   th:value="${sandboxConfig?.clientSecret}" placeholder="Enter SANDBOX Client Secret" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sandboxBaseUrl" class="form-label">Sandbox Base URL</label>
                            <input type="url" class="form-control" id="sandboxBaseUrl" name="sandboxBaseUrl" 
                                   th:value="${sandboxConfig?.sandboxBaseUrl}" placeholder="https://api-m.sandbox.paypal.com">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sandboxProdBaseUrl" class="form-label">Production Base URL</label>
                            <input type="url" class="form-control" id="sandboxProdBaseUrl" name="prodBaseUrl" 
                                   th:value="${sandboxConfig?.prodBaseUrl}" placeholder="https://api-m.paypal.com">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="sandboxReturnUrl" class="form-label">Return URL</label>
                            <input type="text" class="form-control" id="sandboxReturnUrl" name="returnUrl" 
                                   th:value="${sandboxConfig?.returnUrl}" placeholder="/payment/paypal/return">
                            <div class="form-text">Enter relative path (e.g., /payment/paypal/return) or full URL</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="sandboxCancelUrl" class="form-label">Cancel URL</label>
                            <input type="text" class="form-control" id="sandboxCancelUrl" name="cancelUrl" 
                                   th:value="${sandboxConfig?.cancelUrl}" placeholder="/payment/paypal/cancel">
                            <div class="form-text">Enter relative path (e.g., /payment/paypal/cancel) or full URL</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="sandboxBrandName" class="form-label">Brand Name</label>
                            <input type="text" class="form-control" id="sandboxBrandName" name="brandName" 
                                   th:value="${sandboxConfig?.brandName}" placeholder="TechVVS Inventory">
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Save SANDBOX Configuration
                    </button>
                </div>
            </form>
        </div>

        <!-- PROD Configuration -->
        <div class="config-section">
            <div class="config-header">
                <h4><i class="bi bi-cloud-check"></i> PROD Environment Configuration</h4>
            </div>
            
            <form th:action="@{/paypal-config/save-prod}" method="post" th:object="${prodConfig}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="prodClientId" class="form-label">Client ID <span class="required">*</span></label>
                            <input type="text" class="form-control" id="prodClientId" name="clientId" 
                                   th:value="${prodConfig?.clientId}" placeholder="Enter PROD Client ID" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="prodClientSecret" class="form-label">Client Secret <span class="required">*</span></label>
                            <input type="password" class="form-control" id="prodClientSecret" name="clientSecret" 
                                   th:value="${prodConfig?.clientSecret}" placeholder="Enter PROD Client Secret" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="prodBaseUrl" class="form-label">Sandbox Base URL</label>
                            <input type="url" class="form-control" id="prodBaseUrl" name="sandboxBaseUrl" 
                                   th:value="${prodConfig?.sandboxBaseUrl}" placeholder="https://api-m.sandbox.paypal.com">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="prodProdBaseUrl" class="form-label">Production Base URL</label>
                            <input type="url" class="form-control" id="prodProdBaseUrl" name="prodBaseUrl" 
                                   th:value="${prodConfig?.prodBaseUrl}" placeholder="https://api-m.paypal.com">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="prodReturnUrl" class="form-label">Return URL</label>
                            <input type="text" class="form-control" id="prodReturnUrl" name="returnUrl" 
                                   th:value="${prodConfig?.returnUrl}" placeholder="/payment/paypal/return">
                            <div class="form-text">Enter relative path (e.g., /payment/paypal/return) or full URL</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="prodCancelUrl" class="form-label">Cancel URL</label>
                            <input type="text" class="form-control" id="prodCancelUrl" name="cancelUrl" 
                                   th:value="${prodConfig?.cancelUrl}" placeholder="/payment/paypal/cancel">
                            <div class="form-text">Enter relative path (e.g., /payment/paypal/cancel) or full URL</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="prodBrandName" class="form-label">Brand Name</label>
                            <input type="text" class="form-control" id="prodBrandName" name="brandName" 
                                   th:value="${prodConfig?.brandName}" placeholder="TechVVS Inventory">
                        </div>
                    </div>
                </div>
                
                <div class="text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Save PROD Configuration
                    </button>
                </div>
            </form>
        </div>

        <!-- Information Section -->
        <div class="config-section">
            <div class="config-header">
                <h4><i class="bi bi-info-circle"></i> Configuration Information</h4>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-gear"></i> Environment Usage</h6>
                    <ul class="list-unstyled">
                        <li><strong>SANDBOX:</strong> Used when Spring profile is NOT "prod"</li>
                        <li><strong>PROD:</strong> Used when Spring profile is "prod"</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-shield-check"></i> Security Notes</h6>
                    <ul class="list-unstyled">
                        <li>Client secrets are stored securely in the database</li>
                        <li>URLs should be properly configured for your domain</li>
                        <li>Test all configurations before going live</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-secondary">
                <i class="bi bi-house"></i> Back to Home
            </a>
            <a href="/admin" class="btn btn-primary">
                <i class="bi bi-gear"></i> Admin Dashboard
            </a>
        </div>
    </div>

    <script>
        // Form validation and enhancement
        $(document).ready(function() {
            // Add form validation
            $('form').on('submit', function(e) {
                let isValid = true;
                
                // Validate required fields
                $(this).find('input[required]').each(function() {
                    if (!$(this).val().trim()) {
                        $(this).addClass('is-invalid');
                        isValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all required fields.');
                }
            });
            
            // Real-time validation for URLs and URL paths
            $('input[type="url"]').on('blur', function() {
                const url = $(this).val();
                if (url && !isValidUrl(url)) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            // Real-time validation for Return/Cancel URL fields (more flexible)
            $('#sandboxReturnUrl, #sandboxCancelUrl, #prodReturnUrl, #prodCancelUrl').on('blur', function() {
                const url = $(this).val();
                if (url && !isValidUrlOrPath(url)) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            // Show/hide password toggle
            $('input[type="password"]').each(function() {
                const $input = $(this);
                const $toggle = $('<button type="button" class="btn btn-outline-secondary btn-sm position-absolute top-50 end-0 translate-middle-y me-2" style="z-index: 10;"><i class="bi bi-eye"></i></button>');
                
                $input.parent().addClass('position-relative');
                $input.parent().append($toggle);
                
                $toggle.on('click', function() {
                    if ($input.attr('type') === 'password') {
                        $input.attr('type', 'text');
                        $(this).find('i').removeClass('bi-eye').addClass('bi-eye-slash');
                    } else {
                        $input.attr('type', 'password');
                        $(this).find('i').removeClass('bi-eye-slash').addClass('bi-eye');
                    }
                });
            });
        });
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        function isValidUrlOrPath(string) {
            // Allow empty strings
            if (!string || string.trim() === '') {
                return true;
            }
            
            // Check if it's a valid full URL
            if (isValidUrl(string)) {
                return true;
            }
            
            // Check if it's a valid relative path (starts with /)
            if (string.startsWith('/')) {
                // Basic path validation - should not contain invalid characters
                const invalidChars = /[<>:"|?*\x00-\x1f]/;
                return !invalidChars.test(string);
            }
            
            // If it doesn't start with / and isn't a valid URL, it's invalid
            return false;
        }
    </script>
</body>
</html>

