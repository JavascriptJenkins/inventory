<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Sales</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- UIMODE Controlled CSS -->
    <link th:if="${UIMODE == 'MODERN'}" rel="stylesheet" th:href="@{/css/MODERN/modern.css}">
    <link th:if="${UIMODE == 'RETRO'}" rel="stylesheet" th:href="@{/css/RETRO/retro.css}">
    <link th:if="${UIMODE == 'VEGAS'}" rel="stylesheet" th:href="@{/css/VEGAS/vegas.css}">
    <link th:unless="${UIMODE}" rel="stylesheet" th:href="@{/css/MODERN/modern.css}">

    <script th:inline="javascript">
        var editmode = /*[[${editmode}]]*/ false; // Thymeleaf will inject true/false here
        console.log("Edit Mode:", editmode); // Debug to check if it's injected correctly
    </script>
</head>
<body class="sales-page">

<div th:insert="fragments/adminnavbar.html :: adminnavbarfragment"> </div>

<div class="container-fluid">

    <div class="header-dark">
        <h1><i class="bi bi-graph-up me-2"></i>View Sales</h1>
    </div>

    <!-- New Product Edit Section -->
<!--    <div th:if="${!editmode}" class="tip-box">Create a New Menu by typing in New Menu Name.  </div>-->
<!--    <div th:if="${editmode}" class="tip-box">Modify attributes of menu. </div>-->
    <div class="tip-box">View Sales on this sweet graph. </div>

    <div id="successDiv" class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">
        Success
    </div>

    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">
        Error
    </div>


    <form th:action="@{/accounting/admin/sales}" method="get" id="filterForm">

        <!-- Preserve page value on submit -->
        <input type="hidden" name="page" th:value="${page}"/>

        <div class="row mb-3">
            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="record-selector">
                    <label for="customerid">Customer</label>
                    <select class="form-control" id="customerid" name="customerid"
                            onchange="document.getElementById('filterForm').submit()">
                        <option th:value="0">All</option>
                        <option th:each="c : ${customers}" th:value="${c.customerid}" th:text="${c.name}"
                                th:selected="${customerinscope} == ${c.customerid}"></option>
                    </select>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="record-selector">
                    <label for="productid">Product</label>
                    <select class="form-control" id="productid" name="productid"
                            onchange="document.getElementById('filterForm').submit()">
                        <option th:value="0">All</option>
                        <option th:each="p : ${products}" th:value="${p.product_id}" th:text="${p.name}"
                                th:selected="${productinscope} == ${p.product_id}"></option>
                    </select>
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="record-selector">
                    <label for="batchid">Batch</label>
                    <select class="form-control" id="batchid" name="batchid"
                            onchange="document.getElementById('filterForm').submit()">
                        <option th:value="0">All</option>
                        <option th:each="b : ${batches}" th:value="${b.batchid}" th:text="${b.name}"
                                th:selected="${batchinscope} == ${b.batchid}"></option>
                    </select>
                </div>
            </div>
        </div>






        <div class="row mb-4">
            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="record-selector">
                    <label for="startdate">Start Date</label>
                    <input type="datetime-local" class="form-control"
                           id="startdate"
                           name="startdate"
                           th:value="${startdate != null} ? ${#temporals.format(startdate, 'yyyy-MM-dd''T''HH:mm')}"
                           onchange="document.getElementById('filterForm').submit()">
                </div>
            </div>

            <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="record-selector">
                    <label for="enddate">End Date</label>
                    <input type="datetime-local" class="form-control"
                           id="enddate"
                           name="enddate"
                           th:value="${enddate != null} ? ${#temporals.format(enddate, 'yyyy-MM-dd''T''HH:mm')}"
                           onchange="document.getElementById('filterForm').submit()">
                </div>
            </div>
        </div>





    </form>

    <br>

    
    <!-- START: Graph area -->
    <div class="col-12">
        <div class="tip-box">View the sweet graph</div>
        <div class="chart-container p-3">
            <canvas id="revenueChart" width="100%" height="40"></canvas>
        </div>
    </div>
    <!-- END: Graph area -->




</div>
<script th:inline="javascript">
    const revenueData = /*[[${revenuedata}]]*/ [];
    const chartData = JSON.parse(JSON.stringify(revenueData));

    const labels = chartData.map(d => d.date);
    const data = chartData.map(d => d.total);

    const ctx = document.getElementById('revenueChart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Revenue ($)',
                data: data,
                fill: true,
                borderColor: '#00ffff',
                backgroundColor: 'rgba(0, 255, 255, 0.1)',
                tension: 0.3,
                pointBackgroundColor: '#00ffff'
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#fff'
                    }
                }
            }
        }
    });
</script>
</body>
</html>
