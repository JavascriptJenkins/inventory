<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>METRC API Configuration</title>

    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" media="all" href="/css/table.css" th:href="@{/css/table.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Bundle JS (Includes Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        .glowing-valid {
            box-shadow: 0 0 8px 2px #00ffff !important;
        }
        .glowing-invalid {
            box-shadow: 0 0 8px 2px #ff0000 !important;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f1f8fa;
        }
        .table-dark thead {
            background-color: #343a40;
            color: #fff;
        }
        .btn-secondary {
            color: #fff;
            background-color: #343a40;
            border-color: #343a40;
        }
        .btn-secondary:hover {
            background-color: #23272b;
            border-color: #1d2124;
        }
        .header-dark {
            background-color: #343a40;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid transparent;
            border-image: linear-gradient(to right, #c0c0c0, #ffffff);
            border-image-slice: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .tip-box {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 15px #00ffff;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            margin-bottom: 15px;
            animation: glow 1.5s infinite alternate;
        }
        .btn-dark-custom {
            background-color: #343a40;
            color: #fff;
            border: 1px solid #343a40;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .btn-dark-custom:hover {
            background-color: #1d2124;
            color: #f8f9fa;
        }
        @keyframes glow {
            from {
                text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 15px #00ffff;
            }
            to {
                text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 30px #00ffff;
            }
        }
        .config-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .form-label {
            font-weight: 600;
            color: #343a40;
        }
        .help-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .url-input {
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>

<div th:insert="~{fragments/adminnavbar.html :: adminnavbarfragment}"> </div>

<div class="container">

    <div class="header-dark">
        <h1>METRC API Configuration</h1>
    </div>

    <div class="tip-box">Configure METRC API credentials and endpoints for test and production environments.</div>

    <div id="successDiv" class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">
        Success
    </div>

    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">
        Error
    </div>

    <!-- METRC API Configuration Form -->
    <div class="config-section">
        <form th:action="@{/metrc-config/admin/save}" method="post" th:object="${metrcConfig}">
            <!-- Hidden ID field -->
            <input type="hidden" th:field="*{id}">
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">API Key Username</label>
                    <input type="text" th:field="*{apiKeyUsername}" 
                           class="form-control" 
                           placeholder="Enter METRC API username"
                           autocomplete="username">
                    <div class="help-text">The username for METRC API authentication</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">API Key Password</label>
                    <input type="password" th:field="*{apiKeyPassword}" 
                           class="form-control" 
                           placeholder="Enter METRC API password"
                           autocomplete="current-password">
                    <div class="help-text">The password/key for METRC API authentication</div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Test API Base URI</label>
                    <input type="url" th:field="*{testApiKeyBaseUri}" 
                           class="form-control url-input" 
                           placeholder="https://sandbox-api-mn.metrc.com"
                           pattern="https?://.+">
                    <div class="help-text">Base URI for METRC test/sandbox environment</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Production API Base URI</label>
                    <input type="url" th:field="*{prodApiKeyBaseUri}" 
                           class="form-control url-input" 
                           placeholder="https://api-mn.metrc.com"
                           pattern="https?://.+">
                    <div class="help-text">Base URI for METRC production environment</div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Configuration Information</h6>
                        <ul class="mb-0">
                            <li><strong>Test Environment:</strong> Use sandbox credentials for development and testing</li>
                            <li><strong>Production Environment:</strong> Use live credentials for production operations</li>
                            <li><strong>Security:</strong> API credentials are stored securely in the database</li>
                            <li><strong>Default URIs:</strong> 
                                <code>https://sandbox-api-mn.metrc.com</code> (test) and
                                <code>https://api-mn.metrc.com</code> (production)
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <button type="button" class="btn btn-warning me-2" onclick="resetToDefaults()">
                    <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Save Configuration
                </button>
            </div>
        </form>
    </div>

    <!-- Configuration Status Section -->
    <div class="config-section" th:if="${configExists}">
        <h3>Current Configuration Status</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-gear"></i> Configuration Details</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                        <p><strong>Last Updated:</strong> <span th:text="${metrcConfig.updatedAt}"></span></p>
                        <p><strong>Created:</strong> <span th:text="${metrcConfig.createdAt}"></span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Actions</h6>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/metrc-config/admin/delete}" method="post" style="display: inline;">
                            <input type="hidden" name="id" th:value="${metrcConfig.id}">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete this configuration? This action cannot be undone.')">
                                <i class="bi bi-trash"></i> Delete Configuration
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Configuration Message -->
    <div class="config-section" th:if="${!configExists}">
        <div class="alert alert-warning">
            <h4><i class="bi bi-exclamation-triangle"></i> No Configuration Found</h4>
            <p>No METRC API configuration has been set up yet. Please fill in the form above to create your first configuration.</p>
            <p><strong>Recommended:</strong> Start with test/sandbox credentials before using production credentials.</p>
        </div>
    </div>

</div>

<div th:insert="~{fragments/validation.html :: validationfragment}"> </div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize form validation
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input[type="text"], input[type="password"], input[type="url"]');
        
        inputs.forEach(input => {
            input.addEventListener('blur', validateField);
            input.addEventListener('input', clearValidation);
        });
        
        // Auto-format URLs
        const urlInputs = form.querySelectorAll('input[type="url"]');
        urlInputs.forEach(input => {
            input.addEventListener('blur', formatUrl);
        });
    });
    
    function validateField(event) {
        const field = event.target;
        const value = field.value.trim();
        
        // Clear previous validation
        field.classList.remove('glowing-valid', 'glowing-invalid');
        
        // Validate based on field type
        if (field.type === 'url' && value) {
            try {
                new URL(value);
                field.classList.add('glowing-valid');
            } catch (e) {
                field.classList.add('glowing-invalid');
            }
        } else if (field.type === 'password' && value.length < 8) {
            field.classList.add('glowing-invalid');
        } else if (value) {
            field.classList.add('glowing-valid');
        }
    }
    
    function clearValidation(event) {
        const field = event.target;
        field.classList.remove('glowing-invalid');
    }
    
    function formatUrl(event) {
        const field = event.target;
        let value = field.value.trim();
        
        if (value && !value.startsWith('http://') && !value.startsWith('https://')) {
            field.value = 'https://' + value;
        }
    }
    
    function resetToDefaults() {
        if (confirm('Are you sure you want to reset to default values? This will overwrite the current configuration.')) {
            // Create and submit form for reset
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/metrc-config/admin/reset';
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // Auto-save functionality (optional)
    function autoSave() {
        const form = document.querySelector('form');
        const formData = new FormData(form);
        
        // Send AJAX request to save configuration
        fetch('/metrc-config/admin/save', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                console.log('Configuration auto-saved');
            }
        })
        .catch(error => {
            console.error('Auto-save failed:', error);
        });
    }
    
    // Auto-save on field changes (debounced)
    let autoSaveTimeout;
    document.addEventListener('input', function(event) {
        if (event.target.matches('input[type="text"], input[type="password"], input[type="url"]')) {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSave, 2000); // Auto-save after 2 seconds of inactivity
        }
    });
</script>

</body>
</html>
