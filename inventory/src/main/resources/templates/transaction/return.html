<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Return</title>


    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <!-- CSS Theme Selection based on UIMODE -->
    <link rel="stylesheet" type="text/css" media="all" href="/css/MODERN/modern.css" th:if="${UIMODE != 'RETRO'}" />
    <link rel="stylesheet" type="text/css" media="all" href="/css/RETRO/retro.css" th:if="${UIMODE == 'RETRO'}" />
    <link rel="stylesheet" type="text/css" media="all" href="/css/VEGAS/vegas.css" th:if="${UIMODE == 'VEGAS'}" />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <script>
        function processTableItems() {
            const seenBarcodes = new Set();

            $('#deleteItemFromTransactionDiv tbody tr').each(function() {
                const itemBarcode = $(this).data('barcode');

                if (seenBarcodes.has(itemBarcode)) {
                    $(this).remove(); // Delete the row if the barcode is already seen
                } else {
                    seenBarcodes.add(itemBarcode);
                    $(this).show(); // Ensure the row is visible (in case it was hidden previously)
                }
            });

            console.log(Array.from(seenBarcodes)); // This will log the unique barcodes
        }

        $(document).ready(function () {
            processTableItems();
        });

        function deleteItemFromTransaction(element) {
            // Prevent the default link action
            event.preventDefault();

            // Get the barcode from the data-barcode attribute
            const barcode = element.closest('tr').getAttribute('data-barcode');
            console.log(element);
            console.log(barcode);

            const form = document.getElementById('deleteItemFromTransactionForm');

            // Create and append a hidden input for the barcode
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'barcode';
            hiddenInput.value = barcode;
            form.appendChild(hiddenInput);

            // Submit the form
            form.submit();
        }
    </script>

</head>
<body>
<div th:insert="auth/navbar.html :: navbarfragment"> </div>

<div class="return-container">
<div class="container-fluid">
    <div class="header-dark">
        <h1>Return</h1>
    </div>
    <div class="sub-header">
        <p>Transaction ID: <span th:text="${transactionid}"></span></p>
        <p>Customer: <span th:text="${customer.name}"></span></p>
        <p>
            Amount remaining to pay:
            <span th:text="'$' + ${#numbers.formatDecimal(T(java.lang.Math).max(transaction.totalwithtax * 1.0, 0.0), 1, 2)}"></span>
        </p>
    </div>
    <div class="alert alert-danger" role="alert" th:if="${errorMessage}" th:text="${errorMessage}">Error</div>
    <div class="alert alert-success" role="alert" th:if="${successMessage}" th:text="${successMessage}">Success</div>
    <div class="alert alert-primary" role="alert" th:if="${primaryMessage}" th:text="${primaryMessage}">Success</div>


        <div class="form-check mb-3" style="font-size: 1.25rem;">
            <input class="form-check-input" type="checkbox" id="quantityModeCheckbox" style="transform: scale(1.5); margin-right: 10px;">
            <label class="form-check-label" for="quantityModeCheckbox"><strong>Quantity Mode</strong></label>
        </div>



        <!-- Table Section -->
        <div id="deleteItemFromTransactionDiv" class="return-table-container">
            <table class="table table-hover table-striped table-dark table-bordered return-table">
                <thead>
                <tr>
                    <th>Item</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Discounts Active</th>
                    <th>Return Product</th>

                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${transaction.product_list}" th:data-barcode="${item.barcode}">
                    <td th:text="${item.name + ' | ' + item.producttypeid.name}" data-barcode="${item.barcode}">Item Name</td>
                    <td th:text="${item.price}">Price</td>
                    <td th:text="${item.displayquantity}">Quantity</td>

                    <!-- New Discounts Column -->
                    <!-- todo: this needs to show the discount based on product type, not matching on productid -->
                    <td>
                        <span th:if="${transaction.discount_list != null}">
                            <span th:each="discount : ${transaction.discount_list}"
                                  th:if="${discount.isactive == 1 and discount.producttype != null and discount.producttype.producttypeid == item.producttypeid.producttypeid}">

                                <span>
                                    <strong th:text="'$' + ${#numbers.formatDecimal(discount.discountamount, 1, 2)}"></strong>
                                    |
                                    <i class="bi bi-stack" title="Quantity"></i>
                                    <span th:text="${item.displayquantity}"></span>
                                </span>

                            </span>
                        </span>
                    </td>


                    <td>
                        <form th:action="@{/transaction/return}"
                              method="post"
                              th:attr="data-product-name=${item.name}, data-product-type=${item.producttypeid.name}"
                              onsubmit="return handleQuantityMode(this, event)">
                            <input type="hidden" name="discounttype" th:value="${discounttype}" />
                            <input type="hidden" name="barcode" th:value="${item.barcode}" />
                            <input type="hidden" name="transactionid" th:value="${transactionid}" />

                            <input type="hidden" name="quantity" value="1" class="quantity-input" />
                            <input type="hidden" class="available-quantity" th:value="${item.displayquantity}" />


                            <button type="submit" class="btn btn-link p-0 return-action-btn" title="Remove item">
                                <i class="bi bi-x-circle-fill" style="font-size: 1.3rem;"></i>
                            </button>
                        </form>
                    </td>


                </tr>
                </tbody>
            </table>
        </div>

    <a th:href="@{/transaction?transactionid=__${transaction.transactionid}__&size=5&page=1}" class="btn btn-dark" style="margin-top:5px;">Back To Transaction</a>
</div>
</div>

<!-- Quantity Prompt Modal -->
<div class="modal fade return-modal" id="quantityModal" tabindex="-1" aria-labelledby="quantityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="quantityModalLabel">Enter Quantity to Remove</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Inside the modal body -->
                <p><strong>Product:</strong> <span id="modalProductName"></span></p>
                <p><strong>Type:</strong> <span id="modalProductType"></span></p>
                <p id="modalQtyInfo" class="text-muted"></p>

                <input type="number" id="modalQuantityInput" class="form-control" min="1" />

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitQuantity()">Confirm</button>
            </div>
        </div>
    </div>
</div>
<script>
    let currentForm = null;
    let maxQty = 0;

<!-- old working version for submitting with quantity mode checked-->
<!--    function handleQuantityMode(form, event) {-->
<!--        const checkbox = document.getElementById('quantityModeCheckbox');-->
<!--        const quantityMode = checkbox && checkbox.checked;-->

<!--        if (!quantityMode) return true;-->

<!--        event.preventDefault();-->

<!--        currentForm = form;-->
<!--        maxQty = parseInt(form.querySelector('.available-quantity').value);-->

<!--        // Pull product name and type from data attributes on the form-->
<!--        const productName = form.getAttribute('data-product-name') || 'Unknown';-->
<!--        const productType = form.getAttribute('data-product-type') || 'Unknown';-->

<!--        // Set modal field values-->
<!--        document.getElementById('modalQuantityInput').value = 1;-->
<!--        document.getElementById('modalQuantityInput').setAttribute('max', maxQty);-->
<!--        document.getElementById('modalQtyInfo').textContent = `Max quantity available: ${maxQty}`;-->
<!--        document.getElementById('modalProductName').textContent = productName;-->
<!--        document.getElementById('modalProductType').textContent = productType;-->

<!--        const modal = new bootstrap.Modal(document.getElementById('quantityModal'));-->
<!--        modal.show();-->

<!--        return false;-->
<!--    }-->

        function handleQuantityMode(form, event) {
            const checkbox = document.getElementById('quantityModeCheckbox');
            const quantityMode = checkbox && checkbox.checked;

            event.preventDefault(); // always prevent by default

            currentForm = form;
            maxQty = parseInt(form.querySelector('.available-quantity').value);

            const productName = form.getAttribute('data-product-name') || 'Unknown';
            const productType = form.getAttribute('data-product-type') || 'Unknown';

            if (quantityMode) {
                // Quantity mode modal
                document.getElementById('modalQuantityInput').value = 1;
                document.getElementById('modalQuantityInput').setAttribute('max', maxQty);
                document.getElementById('modalQtyInfo').textContent = `Max quantity available: ${maxQty}`;
                document.getElementById('modalProductName').textContent = productName;
                document.getElementById('modalProductType').textContent = productType;

                const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
                quantityModal.show();
            } else {
                // Confirm single return modal
                document.getElementById('confirmReturnMessage').textContent = `Confirm returning 1x ${productName}?`;

                const confirmModal = new bootstrap.Modal(document.getElementById('confirmReturnModal'));
                confirmModal.show();
            }

            return false;
        }

        function submitConfirmReturn() {
            // Set quantity to 1 and submit the form
            if (currentForm) {
                currentForm.querySelector('.quantity-input').value = 1;

                const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmReturnModal'));
                confirmModal.hide();

                currentForm.submit();
            }
        }



    function submitQuantity() {
        const qty = parseInt(document.getElementById('modalQuantityInput').value);

        if (isNaN(qty) || qty <= 0 || qty > maxQty) {
            alert(`Please enter a valid quantity between 1 and ${maxQty}.`);
            return;
        }

        currentForm.querySelector('.quantity-input').value = qty;

        // Close modal and submit form
        const modal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
        modal.hide();

        currentForm.submit();
    }
</script>


<!-- Return Confirmation Modal -->
<div class="modal fade return-modal" id="confirmReturnModal" tabindex="-1" aria-labelledby="confirmReturnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmReturnModalLabel">Confirm Return</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmReturnMessage">Are you sure you want to return this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitConfirmReturn()">Confirm</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>
