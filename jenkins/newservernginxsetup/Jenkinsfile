pipeline {
    agent any

    parameters {
        string(name: 'HOSTNAME', defaultValue: '206.189.183.0', description: 'The hostname or IP address of the remote Ubuntu server')
        string(name: 'TENANT_NAME', defaultValue: 'test', description: 'The tenant name to be used in the server_name for Nginx and Certbot')
    }

    stages {
        stage('Install Nginx') {
            steps {
                script {
                    sshagent(credentials: ['id_ed2_techvvs']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no techvvs@${params.HOSTNAME} << 'EOF'

                            # Update package list and install Nginx
                            sudo apt-get update -y
                            sudo apt-get install -y nginx

                            # Enable Nginx to start on boot and start the service
                            sudo systemctl enable nginx
                            sudo systemctl start nginx

                            echo "Nginx installed and running successfully."

EOF
                        """
                    }
                }
            }
        }

        stage('Configure Nginx Reverse Proxy') {
            steps {
                script {
                    sshagent(credentials: ['id_ed2_techvvs']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no techvvs@${params.HOSTNAME} << 'EOF'

                            # Update the default Nginx configuration file to set up the reverse proxy
                            sudo bash -c 'cat > /etc/nginx/sites-available/default' << EOL
                            server {
                                listen 80 default_server;
                                listen [::]:80 default_server;

                                root /var/www/html;
                                index index.html index.htm index.nginx-debian.html;

                                server_name _;

                                location / {
                                    proxy_pass http://localhost:8081/;
                                }
                            }

                            server {
                                root /var/www/html;
                                index index.html index.htm index.nginx-debian.html;
                                server_name ${params.TENANT_NAME}.techvvs.io; # managed by Certbot

                                location / {
                                    proxy_pass http://localhost:8081/;
                                }
                            }
EOL

                            # Test and reload Nginx configuration
                            sudo nginx -t && sudo systemctl reload nginx

                            echo "Nginx configuration updated with reverse proxy settings."

EOF
                        """
                    }
                }
            }
        }

        stage('Install Certbot and Configure SSL') {
            steps {
                script {
                    sshagent(credentials: ['id_ed2_techvvs']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no techvvs@${params.HOSTNAME} << 'EOF'

                            # Check if ports 80 and 443 are in use
                            if sudo lsof -i :80 || sudo lsof -i :443; then
                                echo "Ports 80 or 443 are already in use. Stopping conflicting services."
                                sudo systemctl stop nginx || true  # Attempt to stop Nginx if running
                            fi

                            # Proceed with Nginx and Certbot installation only if ports are free
                            sudo apt-get update -y
                            sudo apt-get install -y certbot python3-certbot-nginx

                            # Check if SSL certificate already exists
                            CERT_PATH="/etc/letsencrypt/live/${params.TENANT_NAME}.techvvs.io/fullchain.pem"
                            if [ ! -f "\$CERT_PATH" ]; then
                                echo "Generating SSL certificate for ${params.TENANT_NAME}.techvvs.io."
                                sudo certbot --nginx -d ${params.TENANT_NAME}.techvvs.io --non-interactive --agree-tos --email admin@techvvs.io
                            else
                                echo "SSL certificate already exists for ${params.TENANT_NAME}.techvvs.io. Skipping generation."
                            fi

                            # Restart Nginx
                            if ! sudo systemctl restart nginx; then
                                echo "Failed to restart Nginx" >&2
                                exit 1
                            fi

EOF
                        """
                    }
                }
            }
        }




        stage('Verify Nginx Setup') {
            steps {
                script {
                    def url = "https://${params.TENANT_NAME}.techvvs.io"
                    def response = httpRequest(url: url, validResponseCodes: '502')

                    if (!response.content.contains("nginx")) {
                        error "Verification failed: 'nginx' text not found in the response from ${url}"
                    } else {
                        echo "Verification successful: 'nginx' text found in the response from ${url}"
                    }
                }
            }
        }

    }
}
