pipeline {
    agent any

    parameters {
        string(name: 'HOSTNAME', defaultValue: '206.189.183.0', description: 'The hostname or IP address of the remote Ubuntu server')
        string(name: 'TENANT_NAME', defaultValue: 'test', description: 'The tenant name to be used in the server_name for Nginx and Certbot')
    }

    stages {
        stage('Install Nginx') {
            steps {
                script {
                    sshagent(credentials: ['id_ed2_techvvs']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no techvvs@${params.HOSTNAME} << 'EOF'

                            # Update package list and install Nginx
                            sudo apt-get update -y
                            sudo apt-get install -y nginx

                            # Enable Nginx to start on boot and start the service
                            sudo systemctl enable nginx
                            sudo systemctl start nginx

                            echo "Nginx installed and running successfully."

EOF
                        """
                    }
                }
            }
        }

        stage('Configure Nginx Reverse Proxy') {
            steps {
                script {
                    sshagent(credentials: ['id_ed2_techvvs']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no techvvs@${params.HOSTNAME} << 'EOF'

                            # Update the default Nginx configuration file to set up the reverse proxy
                            sudo bash -c 'cat > /etc/nginx/sites-available/default' << EOL
                            server {
                                listen 80 default_server;
                                listen [::]:80 default_server;

                                root /var/www/html;
                                index index.html index.htm index.nginx-debian.html;

                                server_name _;

                                location / {
                                    proxy_pass http://localhost:8081/;
                                }
                            }

                            server {
                                root /var/www/html;
                                index index.html index.htm index.nginx-debian.html;
                                server_name ${params.TENANT_NAME}.techvvs.io; # managed by Certbot

                                location / {
                                    proxy_pass http://localhost:8081/;
                                }
                            }
EOL

                            # Test and reload Nginx configuration
                            sudo nginx -t && sudo systemctl reload nginx

                            echo "Nginx configuration updated with reverse proxy settings."

EOF
                        """
                    }
                }
            }
        }

        stage('Install Certbot and Configure SSL') {
            steps {
                script {
                    sshagent(credentials: ['id_ed2_techvvs']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no techvvs@${params.HOSTNAME} << 'EOF'

                            # Update package lists
                            if ! sudo apt-get update -y; then
                                echo "Failed to update package lists" >&2
                                exit 1
                            fi

                            # Install Certbot and the Certbot Nginx plugin
                            if ! sudo apt-get install -y certbot python3-certbot-nginx; then
                                echo "Failed to install Certbot and Certbot Nginx plugin" >&2
                                exit 1
                            fi

                            # Check if SSL certificate already exists for the domain
                            CERT_PATH="/etc/letsencrypt/live/${params.TENANT_NAME}.techvvs.io/fullchain.pem"
                            if [ ! -f "\$CERT_PATH" ]; then
                                echo "SSL certificate not found. Generating a new certificate for ${params.TENANT_NAME}.techvvs.io."

                                # Generate SSL certificate using Certbot
                                if ! sudo certbot --nginx -d ${params.TENANT_NAME}.techvvs.io --non-interactive --agree-tos --email admin@techvvs.io; then
                                    echo "Certbot failed to obtain an SSL certificate" >&2
                                    exit 1
                                fi
                            else
                                echo "SSL certificate already exists for ${params.TENANT_NAME}.techvvs.io. Skipping certificate generation."
                            fi

                            # Reload Nginx to apply SSL settings
                            if ! sudo systemctl reload nginx; then
                                echo "Failed to reload Nginx service" >&2
                                exit 1
                            fi

                            echo "SSL configuration completed for ${params.TENANT_NAME}.techvvs.io."

EOF
                        """
                    }
                }
            }
        }


        stage('Verify Nginx Setup') {
            steps {
                script {
                    def url = "https://${params.TENANT_NAME}.techvvs.io"
                    def response = httpRequest(url: url, validResponseCodes: '502')

                    if (!response.content.contains("nginx")) {
                        error "Verification failed: 'nginx' text not found in the response from ${url}"
                    } else {
                        echo "Verification successful: 'nginx' text found in the response from ${url}"
                    }
                }
            }
        }

    }
}
